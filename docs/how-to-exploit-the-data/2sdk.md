# Using the SorusBoxScan SDK

The [SorusBoxScan Python SDK](https://github.com/aferre88/5gdrone-sdk) provides tools and libraries to help you develop applications for 5G-enabled drones.

## Features

- Easy integration with 5G drones
- Real-time data streaming
- Advanced drone control APIs
- Comprehensive documentation (in progress)

## Prerequisites
- A system with Python installed
- A virtual environment is recommended for running your project
- The SDK is hosted in a private repository, so you need an authenticated Git session. Username/password prompts will not work on GitHub.

### Setting up a Virtual Environment

#### On Linux, Mac OS or similar

```sh
python -m venv .venv
source .venv/bin/activate
```

#### On Windows, using CMD

```sh
python -m venv .venv
.\.venv\Scripts\activate.bat
```

#### On Windows, using PowerShell

```sh
python -m venv .venv
.\.venv\Scripts\activate.ps1
```

#### On Windows' UNIX-like shells (e.g. Git Bash CLI)

```sh
python -m venv .venv
source .venv/Scripts/activate
```

### Authenticating with GitHub

1. **Install GitHub CLI:**

    In Linux debian-based systems:

    ```bash
    sudo apt-get update
    sudo apt-get install gh
    ```

    In Windows:
    ```sh
    winget install --id GitHub.cli
    ```
    Or go to the [GitHub CLI download page](https://cli.github.com/).

2. **Authenticate GitHub CLI:**
    ```bash
    gh auth login
    ```

3. **Follow the prompts to authenticate:**
    - Select `GitHub.com`.
    - Choose `HTTPS` as the preferred protocol.
    - Authenticate with your preferred method (browser or token).

Now your Git session is authenticated for GitHub on both Linux and Windows using the GitHub CLI.

You can now use git on GitHub's private repositories you have access to just like if they were public.


## Installation
To install the SDK:

```sh
pip install git+https://github.com/aferre88/5gdrone-sdk
```

If your project has a `requirements.txt`, you can run `pip freeze > requirements.txt` to pin the dependency.


## Update
To upgrade the SDK to the latest version:

```sh
pip install git+https://github.com/aferre88/5gdrone-sdk -U
```

## Usage

Hereâ€™s a basic example to get started. You can use this as a template:

??? example "example.py"

    ``` python title="example.py"
    """
    This is an example of how to use the FiveGDroneSDK class to subscribe to the signals topic.
    """

    from fivegdrone_sdk import FiveGDroneSDK

    # Environment variables
    MQTT_BROKER = "mqtt.eclipse.org"
    MQTT_USERNAME = "username"
    MQTT_PASSWORD = "password"
    MQTT_PORT = 1883

    # Create a new instance of the SDK
    hat = FiveGDroneSDK(MQTT_BROKER, MQTT_PORT, MQTT_USERNAME, MQTT_PASSWORD)


    # The @hat.signals decorator is used to subscribe to the signals topic
    # The signal_printer function will be called every time a signal is received
    # The signal object is passed as an argument to the function
    @hat.signals
    def signal_printer(signal):
        """
        In this example, all the attributes of the signal object are printed,
        but you can modify the function to do whatever you want with the signal.

        E.g. if you only need the rssi attribute, you can modify the function like this:

        @hat.signals
        def print_only_rssi(signal):
            print(f"Received signal: {signal.rssi}")
        """
        print("Received signal:")
        for attr, value in signal.__dict__.items():
            if attr == "position":
                print(f"  {attr}:")
                for attr_val, value_val in value.__dict__.items():
                    print(f"    {attr_val}: {value_val}")
                print(f"    decimal degrees: {value.get_decimal_position()}")
                print(f"    degrees, minutes, seconds: {value.get_dms_position()}")
            else:
                print(f"  {attr}: {value}")


    # Starts the MQTT session and blocks the main thread so the program doesn't end
    # If you want the program to end, you can substitute the start_blocking method
    # with the hat.start_async() method.
    hat.start_blocking()

    ```
### Basic integration
#### Import the SDK

```python
from fivegdrone_sdk import FiveGDroneSDK
```

#### Setup the connection to the drone's queue

```python
hat = FiveGDroneSDK(MQTT_BROKER, MQTT_PORT, MQTT_USERNAME, MQTT_PASSWORD)
```

#### Create a signal's handling function
```python
@hat.signals
def signal_handling_function(signal):
    print(f"Signal received in band {signal.frequency_band}")
```
Your function will be called for every signal received from the drone.

Check the [list of attributes for the Signal class](#the-signal-class).

Instead of the ```@hat.signals``` decorator, you can use the ```@hat.raw_signals``` decorator to receive all the information in a single string rather than a Signal object.

#### Loop the connection
You need to trigger the connection loop in order for the MQTT handler to process the messages.

Typically you will need to block the execution of the script to avoid the program exiting rather than keeping the connection open indefinitelly, for doing this, you can use this sentence:

```python
hat.start_blocking()
```

##### Asyncronous loop
If you don't want to block the execution of the script (e.g. you are handling your own threads), you can use the non-blocking alternative:
```python
hat.start_async()
```

#### Sending messages to the queue
Messages can be passed to the queue in order to control the drone or to return information that might be useful for other consumers connected to the queue.
##### Sending an AT command to the hat
E.g. to send the AT message to turn on the GPS module
```python
hat.send('control/command', 'AT+CGPS=1')
```

##### Sending instructions to the drone operator via the instructions topic
```python
hat.send('instructions', 'Go to (53,47)')
```

#### Subscribe and unsubscribe
You can subscribe yourself to arbitrary topics in the MQTT server. This allows you to exchange information between different related systems.

##### Example subscription to the instructions queue
```python
def do_for_each_instructions_message(client, userdata, message):
    print(f"Instructions message: {message.payload.decode()}")

hat.subscribe('instructions', 2, do_for_each_instructions_message) # Topic, QOS, callback
```

You can later undo the subscription with:
```python
hat.unsubscribe('instructions', do_for_each_instructions_message)
```

#### Other functions
##### To ask the hat to pause sending signals
```python
hat.pause()
```

##### To ask the hat to resume sending signals
```python
hat.resume()
```

##### To stop the loop and disconnect from the MQTT server
```python
hat.stop()
```

## The Signal class
The `Signal` class represents signals received from the drone. It is designed to handle various types of signals and provides methods to access and represent these signals.

### Attributes
- `position` ([GPSPosition](#nested-class-gpsposition)): The GPS position data.
- `system_mode` (str): The type of network used by the drone.
- `operation_mode` (str): The mode of operation of the hat. It will usually be ```Online```.
- `mcc` (str): The Mobile Country Code.
- `mnc` (str): The Mobile Network Code.
- `tac` (str): The Tracking Area Code.
- `scell_id` (str): The serving cell ID.
- `pcell_id` (str): The primary cell ID.
- `frequency_band` (str): The frequency band.
- `earfcn` (str): The E-UTRA Absolute Radio Frequency Channel Number.
- `dlbw` (str): The downlink bandwidth.
- `ulbw` (str): The uplink bandwidth.
- `rsrq` (str): The Reference Signal Received Quality.
- `rsrp` (str): The Reference Signal Received Power.
- `rssi` (str): The Received Signal Strength Indicator.
- `rssnr` (str): The Reference Signal Signal-to-Noise Ratio.
- `snr` (str): The Signal-to-Noise Ratio.
- `scs` (str): The Subcarrier Spacing.
- `nr_dl_bw` (str): The NR downlink bandwidth.

Note that not all attributes will be set in all signals, as the device might be connected to multiple bands.

#### When connected to a LTE network
You will receive one signal with the following attributes:

- `position` ([GPSPosition](#nested-class-gpsposition)): The GPS position data.
- `system_mode` (str): The type of network used by the drone.
- `operation_mode` (str): The mode of operation of the hat. It will usually be ```Online```.
- `mcc` (str): The Mobile Country Code.
- `mnc` (str): The Mobile Network Code.
- `tac` (str): The Tracking Area Code.
- `scell_id` (str): The serving cell ID.
- `pcell_id` (str): The primary cell ID.
- `frequency_band` (str): The frequency band.
- `earfcn` (str): The E-UTRA Absolute Radio Frequency Channel Number.
- `dlbw` (str): The downlink bandwidth.
- `ulbw` (str): The uplink bandwidth.
- `rsrq` (str): The Reference Signal Received Quality.
- `rsrp` (str): The Reference Signal Received Power.
- `rssi` (str): The Received Signal Strength Indicator.
- `rssnr` (str): The Reference Signal Signal-to-Noise Ratio.

```system_node``` will be ```LTE```.

#### When connected to a 5G NSA network
You will receive a ```LTE``` signal following the previous definition, and one or more signals with ```system_mode``` set to ```NR5G_NSA``` and the following attributes:

- `position` ([GPSPosition](#nested-class-gpsposition)): The GPS position data.
- `system_mode` (str): The type of network used by the drone.
- `pcell_id` (str): The primary cell ID.
- `frequency_band` (str): The frequency band.
- `earfcn` (str): The E-UTRA Absolute Radio Frequency Channel Number.
- `rsrp` (str): The Reference Signal Received Power.
- `rsrq` (str): The Reference Signal Received Quality.
- `snr` (str): The Signal-to-Noise Ratio.
- `scs` (str): The Subcarrier Spacing.
- `nr_dl_bw` (str): The NR downlink bandwidth.

#### When connected to a 5G SA network
You will receive signals with the ```system_mode``` set to ```NR5G_SA```, and the following attributes:

- `position` ([GPSPosition](#nested-class-gpsposition)): The GPS position data.
- `system_mode` (str): The type of network used by the drone.
- `operation_mode` (str): The mode of operation of the hat. It will usually be ```Online```.
- `mcc` (str): The Mobile Country Code.
- `mnc` (str): The Mobile Network Code.
- `tac` (str): The Tracking Area Code.
- `scell_id` (str): The serving cell ID.
- `pcell_id` (str): The primary cell ID.
- `frequency_band` (str): The frequency band.
- `earfcn` (str): The E-UTRA Absolute Radio Frequency Channel Number.
- `rsrp` (str): The Reference Signal Received Power.
- `rsrq` (str): The Reference Signal Received Quality.
- `snr` (str): The Signal-to-Noise Ratio.


#### When not connected to a network
You will receive signals with the ```system_mode``` set to ```NO SERVICE```, and the following attributes:

- `position` ([GPSPosition](#nested-class-gpsposition)): The GPS position data.
- `system_mode` (str): The type of network used by the drone.
- `operation_mode` (str): The mode of operation of the hat. It will usually be ```Online```.

### Nested Class: GPSPosition
The `GPSPosition` class represents GPS position data.

#### Methods

##### `get_datetime(self)`
Returns the date and time reported by the GPS service.

**Returns:**
- `datetime`: Date and time reported by the GPS service.

##### `get_position(self)`
Returns the GPS position in DDMM.MMMMMM format (decimal minutes).

**Returns:**
- `tuple`: A tuple containing the latitude and longitude of the GPS position.
    - `float`: Latitude in DDMM.MMMMMM format.
    - `str`: Latitude direction (N or S).
    - `float`: Longitude in DDMM.MMMMMM format.
    - `str`: Longitude direction (E or W).

##### `get_decimal_position(self)`
Returns the GPS position in decimal degrees.

**Returns:**
- `tuple`: A tuple containing the latitude and longitude of the GPS position.
    - `float`: Latitude in decimal degrees.
    - `float`: Longitude in decimal degrees.

##### `get_dms_position(self)`
Returns the GPS position in sexagesimal format.

**Returns:**
- `tuple`: A tuple containing the latitude and longitude of the GPS position.
    - `tuple`: A tuple containing the latitude in sexagesimal format.
        - `int`: Degrees.
        - `int`: Minutes.
        - `float`: Seconds.
        - `str`: Direction (N or S).
    - `tuple`: A tuple containing the longitude in sexagesimal format.
        - `int`: Degrees.
        - `int`: Minutes.
        - `float`: Seconds.
        - `str`: Direction (E or W).

##### `get_altitude_meters(self)`
Returns the altitude of the GPS position in meters.

**Returns:**
- `float`: The altitude of the GPS in meters.

##### `get_speed_knots(self)`
Returns the speed of the GPS position in knots.

**Returns:**
- `float`: The speed of the GPS in knots.

##### `get_speed_kmh(self)`
Returns the speed of the GPS position in km/h.

**Returns:**
- `float`: The speed of the GPS in km/h.

##### `get_course(self)`
Returns the course of the GPS position.

**Returns:**
- `float`: The course of the GPS position.